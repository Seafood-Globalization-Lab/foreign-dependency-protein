---
title: "01_Analysis_test"
author: "Connor Quiroz and Jessica Gephart"
date: "2025-06-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(arrow)
library(countrycode)
library(exploreARTIS)
library(data.table)
library(here)

# Create function from R folder if not building as a package
source("../R/standardize_country_data.R")
source("../R/update_population_data.R")
```

This file independently produces the supply sourcing file as a test. 

The desired final file should have the following columns: 
* consumer_iso3c
* year
* population
* source (foreign/domestic/error, capture/aquaculture/error)
* supply_percap_kg (from FAO 'Food supply quantity (kg/capita/yr)')

```{r read in data created from 00_Preprocess_Data}
# Read in consumption data
# Set parquet database folder location
# db_folder <- "/Users/gephart/Library/CloudStorage/Dropbox/Research/ARTIS/ARTIS_1.1.0_FAO_2025_08_02/"
db_folder <- paste0(here(),"/data/ARITS_1.1.0_FAO_2025_08_02")

artis_ds <- arrow::open_dataset(file.path(db_folder, "datasets", "ARTIS_consumption_v1.1.0_FAO_mid_2025-08-02.parquet"))

# Summarize consumption file by source country
artis_ts_result <- artis_ds %>%
  filter(
    end_use == "direct human consumption",
    (hs_version == "HS96" & year <= 2003) |
      (hs_version == "HS02" & year >= 2004 & year <= 2009) |
      (hs_version == "HS07" & year >= 2010 & year <= 2012) |
      (hs_version == "HS12" & year >= 2013 & year <= 2020)
  ) %>%
  group_by(year, consumer_iso3c, consumption_source, habitat, method) %>%
  summarise(consumption_live_t = sum(consumption_live_t, na.rm = TRUE))

consumption_full <- artis_ts_result %>%
  collect() %>%
  mutate(consumption_source = str_replace(consumption_source, " step 1", ""),
         consumption_source = str_replace(consumption_source, " step 2", ""))
```

> We will run initial checks on the data by checking FAO FBS population data that has not had their territories corrected to the Worldbank population data. No territory aggregation, just checking country to country populations.

```{r run checks on population data}
# Read in and clean new FAO food balance sheet data
fao_new_raw <- read_parquet("../output/fao_food.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
         Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F"), 
         -ends_with("N")) %>%
  pivot_longer(cols = Y2010:Y2022, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  mutate(data_source = "new FBS") %>% 
  # Add iso3c column
  mutate(iso3c = countrycode(Area, origin = 'country.name', destination = 'iso3c')) %>%
  relocate(iso3c, .before = "Area") %>%
  ## Manually add in select iso3c codes
  mutate(iso3c = case_when(
    Area == "Netherlands Antilles (former)" ~ "ANT",
    TRUE ~ iso3c
  )) %>%
  # left_join(standardized_country_iso3c %>% 
  #             filter(!is.na(input_iso3c)), by = c("iso3c" = "input_iso3c", "year")) %>%
  # mutate(iso3c = case_when(is.na(output_iso3c) ~ iso3c, # an NA in output_iso3c means the original iso3c value is a country
  #                          !is.na(output_iso3c) ~ output_iso3c)) %>% 
  # group_by(iso3c, year, Element, `Element Code`, Unit, `Item Code (FBS)`, `Item Code`, Item) %>%
  # summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_source = "new FBS") 

# Get historical FBS population values
fbs_old_pops <- read_parquet("../output/fao_historical.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
          Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F")) %>%
  pivot_longer(cols = Y1961:Y2013, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  # Only keep years 1996 and after to align with ARTIS
  filter(year >= 1996) %>%
  mutate(data_source = "old FBS") %>%
  filter(Element == "Total Population - Both sexes") %>%
  rename(population = "value") %>%
  select(Area, year, population)

# Read in and clean historical FAO food balance sheet data
fao_old_raw <- read_parquet("../output/fao_historical.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
          Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F")) %>%
  pivot_longer(cols = Y1961:Y2013, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  # Only keep years 1996 and after to align with ARTIS
  filter(year >= 1996) %>%
  mutate(data_source = "old FBS") %>%
  left_join(fbs_old_pops, by = c("Area", "year")) %>%
  mutate(value = case_when( # Derive annual protein supply (we're going to recalculate per capita since FBS doesn't aggregate fully by country (but separates by territory)
    Element == "Protein supply quantity (g/capita/day)" ~ (value * population * 365) / 1e6,
    TRUE ~ value
  ),
  Element = case_when(Element == "Protein supply quantity (g/capita/day)" ~ "Protein supply quantity (t)",
                      TRUE ~ Element),
  Unit = case_when(Element == "Protein supply quantity (t)" ~ "t",
                   TRUE ~ Unit)
  ) %>%
  # Add iso3c column
  mutate(iso3c = countrycode(Area, origin = 'country.name', destination = 'iso3c')) %>%
  relocate(iso3c, .before = "Area") %>%
  # NAs in iso3c column must be resolved before join
  ## remove countries that did not exist within ARTIS years
  filter(!(Area %in% c("Belgium-Luxembourg", "Czechoslovakia", "Yugoslav SFR"))) %>%
  ## Manually add in select iso3c codes
  mutate(iso3c = case_when(
    Area == "Netherlands Antilles (former)" ~ "ANT",
    Area == "Serbia and Montenegro" ~ "SCG",
    TRUE ~ iso3c
  )) %>%
  # left_join(standardized_country_iso3c, by = c("iso3c" = "input_iso3c", "year")) %>%
  # mutate(iso3c = case_when(is.na(output_iso3c) ~ iso3c, # an NA in output_iso3c means the original iso3c value is a country
  #                          !is.na(output_iso3c) ~ output_iso3c)) %>% 
  group_by(iso3c, year, Element, `Element Code`, Unit, `Item Code (FBS)`, `Item Code`, Item) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_source = "old FBS")

# Obtain FBS Population data
population <- fao_old_raw %>%
  filter(Element == "Total Population - Both sexes") %>%
  select(year, iso3c, data_source, "population" = "value") %>%
  bind_rows(fao_new_raw %>%
  filter(Element == "Total Population - Both sexes") %>%
  select(year, iso3c, data_source, "population" = "value")) %>%
  # original unit is 1000 people - convert unit to people
  mutate(population = 1000*population) %>%
  # Prioritize new fbs in overlapping years
  filter(!(year %in% 2010:2013 & data_source == "old FBS"))


# One country: SCG Doesn't have any available population data.
world_bank <- read.csv("../data/population_data_worldbank.csv")

# Pivot to long format
world_bank_long <- world_bank %>%
  mutate(iso3c = countrycode(Country.Name, origin = "country.name", destination = "iso3c")) %>%
  filter(!is.na(iso3c)) %>%
  select(iso3c, starts_with("X")) %>%
  pivot_longer(
    cols = -iso3c,
    names_to = "year",
    values_to = "population"
  ) %>%
  mutate(
    year = as.integer(sub("X", "", year)),        # Remove 'X' prefix
    population = as.numeric(population)
  )  %>%
  select(iso3c, year, population) %>%
  arrange(iso3c, year)
  
# # Join the population data (for visualization / t test)
joined_population <- left_join(population %>%
                                 filter(!(year %in% 2010:2013 & data_source == "old FBS")), world_bank_long, by = c("year", "iso3c"))

# Calculate absolute differences between 
absolute_diff_dataset <- joined_population %>%
  mutate(absolute_diff = abs(population.x-population.y)) %>%
  arrange(-absolute_diff)

# Log absolute differences betwen FBS and WorldBank population data
absolute_diff_dataset %>%
ggplot(aes(y = log(absolute_diff), x = data_source, fill = data_source)) +
  geom_boxplot() +
  labs(y = "Absolute Difference") +
  theme_minimal()
```

> Result: Differences between FAO-FBS and WorldBank data are very large. As seen from the boxplot that are log transformed, the median is around 11 for both datasets, which e^11 = 59874 difference in people per country per year. Moving forward, we will include both FBS and WorldBank population columns in the final dataset, but will only calculate per capita values using FAO-FBS columns.

```{r go forth running country standardization}
# Standardize country names
standardized_country_iso3c <- standardize_country_data() %>%
  select(year, input_iso3c, output_iso3c) %>%
  distinct() %>%
  filter(!is.na(input_iso3c))

# Read in and clean new FAO food balance sheet data
fao_new_raw <- read_parquet("../output/fao_food.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
         Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F"), 
         -ends_with("N")) %>%
  pivot_longer(cols = Y2010:Y2022, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  mutate(data_source = "new FBS") %>% 
  # Add iso3c column
  mutate(iso3c = countrycode(Area, origin = 'country.name', destination = 'iso3c')) %>%
  # Hand correct FBS country names that weren't matched to iso3c via countrycode.
  mutate(iso3c = case_when(
    str_detect(Area, "T\xfcrkiye") ~ "TUR",
    str_detect(Area, "Serbia and Montenegro") ~ "SCG",
    str_detect(Area, "Netherlands Antilles (former)") ~ "NLD",
    str_detect(Area, "C\xf4te d'Ivoire") ~ "CIV",
    TRUE ~ iso3c)
  ) %>%
  relocate(iso3c, .before = "Area") %>%
  ## Manually add in select iso3c codes
  mutate(iso3c = case_when(
    Area == "Netherlands Antilles (former)" ~ "ANT",
    TRUE ~ iso3c
  )) %>%
  # Implement country standardization
  left_join(standardized_country_iso3c, by = c("iso3c" = "input_iso3c", "year")) %>%
  mutate(iso3c = case_when(is.na(output_iso3c) ~ iso3c, # an NA in output_iso3c means the original iso3c value is a country
                           !is.na(output_iso3c) ~ output_iso3c)) %>% 
  group_by(iso3c, year, Element, `Element Code`, Unit, `Item Code (FBS)`, `Item Code`, Item) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_source = "new FBS") 

# Get historical FBS population values
fbs_old_pops <- read_parquet("../output/fao_historical.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
          Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F")) %>%
  pivot_longer(cols = Y1961:Y2013, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  # Only keep years 1996 and after to align with ARTIS
  filter(year >= 1996) %>%
  mutate(data_source = "old FBS") %>%
  filter(Element == "Total Population - Both sexes") %>%
  rename(population = "value") %>%
  select(Area, year, population)

# Read in and clean historical FAO food balance sheet data
fao_old_raw <- read_parquet("../output/fao_historical.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
          Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F")) %>%
  pivot_longer(cols = Y1961:Y2013, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  # Only keep years 1996 and after to align with ARTIS
  filter(year >= 1996) %>%
  mutate(data_source = "old FBS") %>%
  left_join(fbs_old_pops, by = c("Area", "year")) %>%
  mutate(value = case_when( # Derive annual protein supply (we're going to recalculate per capita since FBS doesn't aggregate fully by country (but separates by territory)
    Element == "Protein supply quantity (g/capita/day)" ~ (value * 1e6) / (population * 365),
    TRUE ~ value
  ),
  Element = case_when(Element == "Protein supply quantity (g/capita/day)" ~ "Protein supply quantity (t)",
                      TRUE ~ Element),
  Unit = case_when(Element == "Protein supply quantity (t)" ~ "t",
                   TRUE ~ Unit)
  ) %>%
  # Add iso3c column
  mutate(iso3c = countrycode(Area, origin = 'country.name', destination = 'iso3c')) %>%
  # Hand correct FBS country names that weren't matched to iso3c via countrycode.
  mutate(iso3c = case_when(
    str_detect(Area, "T\xfcrkiye") ~ "TUR",
    str_detect(Area, "Serbia and Montenegro") ~ "SCG",
    str_detect(Area, "Netherlands Antilles (former)") ~ "NLD",
    str_detect(Area, "C\xf4te d'Ivoire") ~ "CIV",
    TRUE ~ iso3c)
  ) %>%
  relocate(iso3c, .before = "Area") %>%
  # NAs in iso3c column must be resolved before join
  ## remove countries that did not exist within ARTIS years
  filter(!(Area %in% c("Belgium-Luxembourg", "Czechoslovakia", "Yugoslav SFR"))) %>%
  ## Manually add in select iso3c codes
  mutate(iso3c = case_when(
    Area == "Netherlands Antilles (former)" ~ "ANT",
    Area == "Serbia and Montenegro" ~ "SCG",
    TRUE ~ iso3c
  )) %>%
  # Implement country standardization
  left_join(standardized_country_iso3c, by = c("iso3c" = "input_iso3c", "year")) %>%
  mutate(iso3c = case_when(is.na(output_iso3c) ~ iso3c, # an NA in output_iso3c means the original iso3c value is a country
                           !is.na(output_iso3c) ~ output_iso3c)) %>%
  group_by(iso3c, year, Element, `Element Code`, Unit, `Item Code (FBS)`, `Item Code`, Item) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_source = "old FBS") %>%
  # Get rid of countries with 0'ed out total protein values - this can lead to infinity estimates
  filter(!(value == 0 & str_detect(Element, "Protein") & Item == "Animal Products"))
```
```{r create select data frames from FBS data}
# Set elements to keep 
# NOTE: How reasonable applying the live weight proportions here will 
# vary by element. Need to consider which to ultimately keep. 
# Per capita elements of interest left out and calculated manually later to 
# ensure consistency with country boundaries
elements_select <- c("Food supply (kcal)", 
                     "Protein supply quantity (t)", 
                     # FIXIT: check difference between next two elements
                     "Domestic supply quantity",
                     "Food")

aquatic_animals <- c("Cephalopods",
                     "Crustaceans", "Demersal Fish",
                     "Freshwater Fish", "Marine Fish, Other",
                     "Molluscs, Other", "Pelagic Fish")

# Create data frame of aquatic animal products only for disaggregation by source
fao_new_aquatic <- fao_new_raw %>%
  filter(Item %in% aquatic_animals,
         Element %in% elements_select) %>%
  group_by(year, iso3c, Element, Unit, data_source) %>%
  summarise(value = sum(value, na.rm = TRUE)) %>%
  ungroup()

fao_old_aquatic <- fao_old_raw %>%
  filter(Item %in% aquatic_animals,
         Element %in% elements_select) %>%
  group_by(year, iso3c, Element, Unit, data_source) %>%
  summarise(value = sum(value, na.rm = TRUE)) %>%
  ungroup()
```

```{r update per capita values}
# New FAO aquatic animals dataset
fao_new_aquatic <- update_population_data(fao_new_aquatic,
                                          animal_products = FALSE,
                                          historical = FALSE)
# Historical FAO aquatic animals dataset
fao_old_aquatic <- update_population_data(fao_old_aquatic,
                                          animal_products = FALSE,
                                          historical = TRUE)
# New FAO animals dataset
fao_new_raw <- update_population_data(fao_new_raw,
                       animal_products = TRUE,
                       historical = FALSE)
# Historical FAO animals dataset
fao_old_raw <- update_population_data(fao_old_raw,
                       animal_products = TRUE,
                       historical = TRUE)
```

```{r clean consumption data}
consumption_props <- consumption_full %>%
  group_by(year, consumer_iso3c, consumption_source, habitat, method) %>%
  summarise(consumption_live_t = sum(consumption_live_t)) %>%
  group_by(year, consumer_iso3c) %>%
  mutate(aquatic_source_prop = consumption_live_t/sum(consumption_live_t)) %>%
  select(-consumption_live_t) %>%
  ungroup()

# Test that all add back to 1
test <- consumption_props %>%
  group_by(year, consumer_iso3c) %>%
  summarise(test_val = sum(aquatic_source_prop)) %>%
  filter(abs(test_val-1) > 0.000001) 
```

```{r calculate percent of protein from aquatic animals}
fao_new_prop_aquatic <- fao_new_raw %>%
  # Filter to the total animal product protein supply
  filter(Element == "Protein supply quantity (g/capita/day)",
         Item == "Animal Products") %>%
  select("year", "iso3c", "data_source", "total_animal_protein" = "value") %>%
  # Join aquatic animal data and filter to product protein supply
  full_join(fao_new_aquatic %>%
              filter(Element == "Protein supply quantity (g/capita/day)") %>%
              select("year", "iso3c", "data_source", 
                     "aquatic_animal_protein" = "value"), 
            by = c("year", "iso3c", "data_source")) %>%
  mutate(value = aquatic_animal_protein/total_animal_protein,
         Element = "Proportion animal source protein from aquatic",
         Unit = "Proportion") %>%
  select(-total_animal_protein, -aquatic_animal_protein)

fao_old_prop_aquatic <- fao_old_raw %>%
  # Filter to the total animal product protein supply
  filter(Element == "Protein supply quantity (g/capita/day)",
         Item == "Animal Products") %>%
  select("year", "iso3c", "data_source", "total_animal_protein" = "value") %>%
  # Join aquatic animal data and filter to product protein supply
  full_join(fao_old_aquatic %>%
              filter(Element == "Protein supply quantity (g/capita/day)") %>%
              select("year", "iso3c", "data_source", 
                     "aquatic_animal_protein" = "value"), 
            by = c("year", "iso3c", "data_source")) %>%
  mutate(value = aquatic_animal_protein/total_animal_protein,  
         Element = "Proportion animal source protein from aquatic",
         Unit = "Proportion") %>%
  select(-total_animal_protein, -aquatic_animal_protein)

# Add proportion animal source protein from aquatic data to aquatic data frames and join all together
fao_aquatic <- fao_new_aquatic %>%
  bind_rows(fao_new_prop_aquatic) %>%
  bind_rows(fao_old_aquatic) %>%
  bind_rows(fao_old_prop_aquatic)

rm(list = c("fao_new_prop_aquatic", "fao_old_prop_aquatic"))
```

```{r disaggregate fbs measures}
fao_aquatic_source <- fao_aquatic %>%
  left_join(consumption_props, 
            by = c("year", "iso3c" = "consumer_iso3c"),
            # FIXIT: confirm this should be many-to-many
            relationship = "many-to-many") %>%
  # Disaggregate proportionately to ARTIS consumption sourcing
  mutate(value = value*aquatic_source_prop) %>%
  # add in FAO FBS population data
  left_join(population %>%
              rename(population_fao_fbs = "population"), 
            by = c("year", "iso3c", "data_source")) %>%
  # Add in worldbank population data
  left_join(world_bank_long %>%
              rename(population_world_bank = "population"),
  by = c("year", "iso3c"))

# FIXIT: Test is not currently working - seems to be related to country cleaning (e.g., China duplicates likely due to China vs China, Mainland)
tmp <- fao_aquatic_source %>% 
  group_by(year, iso3c, Element, data_source) %>%
  summarise(test = sum(aquatic_source_prop)) %>%
  filter(abs(test-1) > 0.0001)

# Add in population data
  

# FIXIT: Test not passing, seemingly only for iso codes not in ARTIS. Check if this passes after new country standardization
tmp <- fao_aquatic_source %>%
  filter(is.na(value))

# FIXIT: For now, filter out missing values, but determine handling after confirming source of NAs
fao_aquatic_source <- fao_aquatic_source %>%
  filter(!is.na(value))
  
# Write final data output to .csv
# write_csv(fao_aquatic_source, "../output/fao_aquatic_source.csv")
```