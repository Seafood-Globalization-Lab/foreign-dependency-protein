---
title: "01_Analysis_test"
author: "Connor Quiroz and Jessica Gephart"
date: "2025-06-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(arrow)
library(countrycode)
library(exploreARTIS)
library(data.table)

# Create function from R folder if not building as a package
source("../R/standardize_country_data.R")
source("../R/update_population_data.R")
```

This file independently produces the supply sourcing file as a test. 

The desired final file should have the following columns: 
* consumer_iso3c
* year
* population
* source (foreign/domestic/error, capture/aquaculture/error)
* supply_percap_kg (from FAO 'Food supply quantity (kg/capita/yr)')

```{r read in data created from 00_Preprocess_Data}
# Read in consumption data
consumption_full <- read_parquet("../output/consumption_full.parquet")

# Standardize country names
standardized_countries <- standardize_country_data() %>%
  # FIXIT: confirm this is correct, but this is an attempt to ensure each input_iso - year combination has a single output
  select(year, input_iso3c, output_iso3c) %>%
  distinct() 
  

# Read in and clean new FAO food balance sheet data
fao_new_raw <- read_parquet("../output/fao_food.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
         Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F"), 
         -ends_with("N")) %>%
  pivot_longer(cols = Y2010:Y2022, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  mutate(data_source = "new FBS") %>% 
  # Add iso3c column
  mutate(iso3c = countrycode(Area, origin = 'country.name', destination = 'iso3c')) %>%
  relocate(iso3c, .before = "Area") %>%
  ## Manually add in select iso3c codes
  mutate(iso3c = case_when(
    Area == "Netherlands Antilles (former)" ~ "ANT",
    TRUE ~ iso3c
  )) %>%
  left_join(standardized_countries %>% 
              filter(!is.na(input_iso3c)), by = c("iso3c" = "input_iso3c", "year")) %>%
  mutate(iso3c = case_when(is.na(output_iso3c) ~ iso3c, # an NA in output_iso3c means the original iso3c value is a country
                           !is.na(output_iso3c) ~ output_iso3c)) %>% 
  group_by(iso3c, year, Element, `Element Code`, Unit, `Item Code (FBS)`, `Item Code`, Item) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_source = "new FBS") 

# Get historical FBS population values
fbs_old_pops <- read_parquet("../output/fao_historical.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
          Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F")) %>%
  pivot_longer(cols = Y1961:Y2013, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  # Only keep years 1996 and after to align with ARTIS
  filter(year >= 1996) %>%
  mutate(data_source = "old FBS") %>%
  filter(Element == "Total Population - Both sexes") %>%
  rename(population = "value") %>%
  select(Area, year, population)

# Read in and clean historical FAO food balance sheet data
fao_old_raw <- read_parquet("../output/fao_historical.parquet") %>% 
  # Remove aggregated regions
  filter(`Area Code` < 1000,
          Area != "China") %>% # China included in other names that FBS has
  # Remove flag columns
  select(-ends_with("F")) %>%
  pivot_longer(cols = Y1961:Y2013, names_to = "year") %>%
  # Convert year column to numeric after removing "Y" prefix
  mutate(year = as.numeric(str_replace(year, "Y", ""))) %>%
  # Only keep years 1996 and after to align with ARTIS
  filter(year >= 1996) %>%
  mutate(data_source = "old FBS") %>%
  left_join(fbs_old_pops, by = c("Area", "year")) %>%
  mutate(value = case_when( # Derive annual protein supply (we're going to recalculate per capita since FBS doesn't aggregate fully by country (but separates by territory)
    Element == "Protein supply quantity (g/capita/day)" ~ (value * population * 365) / 1e6,
    TRUE ~ value
  ),
  Element = case_when(Element == "Protein supply quantity (g/capita/day)" ~ "Protein supply quantity (t)",
                      TRUE ~ Element),
  Unit = case_when(Element == "Protein supply quantity (t)" ~ "t",
                   TRUE ~ Unit)
  ) %>%
  # Add iso3c column
  mutate(iso3c = countrycode(Area, origin = 'country.name', destination = 'iso3c')) %>%
  relocate(iso3c, .before = "Area") %>%
  # NAs in iso3c column must be resolved before join
  ## remove countries that did not exist within ARTIS years
  filter(!(Area %in% c("Belgium-Luxembourg", "Czechoslovakia", "Yugoslav SFR"))) %>%
  ## Manually add in select iso3c codes
  mutate(iso3c = case_when(
    Area == "Netherlands Antilles (former)" ~ "ANT",
    Area == "Serbia and Montenegro" ~ "SCG",
    TRUE ~ iso3c
  )) %>%
  left_join(standardized_countries, by = c("iso3c" = "input_iso3c", "year")) %>%
  mutate(iso3c = case_when(is.na(output_iso3c) ~ iso3c, # an NA in output_iso3c means the original iso3c value is a country
                           !is.na(output_iso3c) ~ output_iso3c)) %>% 
  group_by(iso3c, year, Element, `Element Code`, Unit, `Item Code (FBS)`, `Item Code`, Item) %>%
  summarize(value = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(data_source = "old FBS") 
```

```{r create select data frames from FBS data}
# Set elements to keep 
# NOTE: How reasonable applying the live weight proportions here will 
# vary by element. Need to consider which to ultimately keep. 
elements_select <- c("Food supply (kcal/capita/day)", 
                     "Food supply (kcal)", 
                     "Protein supply quantity (g/capita/day)",
                     "Protein supply quantity (t)", 
                     # FIXIT: check difference between next two elements
                     "Domestic supply quantity",
                     "Food supply quantity (kg/capita/yr)")

aquatic_animals <- c("Cephalopods",
                     "Crustaceans", "Demersal Fish",
                     "Freshwater Fish", "Marine Fish, Other",
                     "Molluscs, Other", "Pelagic Fish")

# Create data frame of aquatic animal products only for disaggregation by source
fao_new_aquatic <- fao_new_raw %>%
  filter(Item %in% aquatic_animals,
         Element %in% elements_select,
         !Element %in% c("Food supply (kcal/capita/day)", 
                        "Protein supply quantity (g/capita/day)",
                        "Food supply quantity (kg/capita/yr)")) %>%
  group_by(year, iso3c, Element, Unit, data_source) %>%
  summarise(value = sum(value, na.rm = TRUE)) %>%
  ungroup()

fao_old_aquatic <- fao_old_raw %>%
  filter(Item %in% aquatic_animals,
         Element %in% elements_select,
         !Element %in% c("Food supply (kcal/capita/day)", 
                        "Protein supply quantity (g/capita/day)",
                        "Food supply quantity (kg/capita/yr)")) %>%
  group_by(year, iso3c, Element, Unit, data_source) %>%
  summarise(value = sum(value, na.rm = TRUE)) %>%
  ungroup()

# Obtain FBS Population data
population <- fao_old_raw %>%
  filter(Element == "Total Population - Both sexes") %>%
  select(year, iso3c, data_source, "population" = "value") %>%
  bind_rows(fao_new_raw %>%
  filter(Element == "Total Population - Both sexes") %>%
  select(year, iso3c, data_source, "population" = "value")) %>%
  # original unit is 1000 people - convert unit to people
  mutate(population = 1000*population)

# Store 0'ed out populations in separate dataframe
fbs_with_zeros <- population %>%
  filter(population == 0)

# Filter out 0'ed out populations from population data
population <- population %>%
  filter(population != 0)

# Problem: FBS has countries with 0's in their population. We need to find a way to fill this data in (or delete it if there's no reliable way)
# # TRY TO FILL IN FBS DATA WITH WorldBank
# # Countries from FBS with missing population data
missing_countries <- fbs_with_zeros %>%
  distinct(iso3c) %>%
  pull(iso3c)

# One country: SCG Doesn't have any available population data.
world_bank <- read.csv("../data/population_data_worldbank.csv")

# Pivot to long format
world_bank_long <- world_bank %>%
  mutate(iso3c = countrycode(Country.Name, origin = "country.name", destination = "iso3c")) %>%
  filter(!is.na(iso3c)) %>%
  select(iso3c, starts_with("X")) %>%
  pivot_longer(
    cols = -iso3c,
    names_to = "year",
    values_to = "population"
  ) %>%
  mutate(
    year = as.integer(sub("X", "", year)),        # Remove 'X' prefix
    population = as.numeric(population)
  )  %>%
  select(iso3c, year, population) %>%
  arrange(iso3c, year)

# Create countries object for countries with missing population data
countries <- missing_countries
  
# # Join the population data (for visualization / t test)
joined_population <- left_join(population %>%
                                 filter(!(year %in% 2010:2013 & data_source == "old FBS"),
                                        iso3c %in% countries), world_bank_long %>% filter(iso3c %in% countries), by = c("year", "iso3c"))

# t tests to compare population values
valid_iso3c <- joined_population %>%
  filter(!is.na(population.x), !is.na(population.y)) %>%
  group_by(iso3c) %>%
  mutate(
    n_x = sum(!is.na(population.x)),
    n_y = sum(!is.na(population.y))
  ) %>%
  select(-n_x, -n_y) %>%
  filter(iso3c %in% countries) %>%
  filter(year > 2010)

# Calculate absolute differences between 
valid_iso3c <- valid_iso3c %>%
  mutate(absolute_diff = abs(population.x-population.y))

# Calculate p-values between 0'ed countries populaton values
p_vals <- valid_iso3c %>%
  split(.$iso3c) %>%
  map(~t.test(.x$population.x, .x$population.y)) %>%
  map_df(broom::tidy, .id = 'iso3c')

# Look at p values comparing population sizes in FBS vs WorldBank data
# Majority of p-values are greater than 0.05. Meaning the FBS and WorldBank data countries with 0's in their data are very similar. Meaning it is reliable to impute Worldbank data for FBS Data
p_vals %>%
  select(iso3c, p.value) %>%
  mutate(dd = round(p.value, 2)) %>%
  arrange(-p.value)

# Update FBS missing countries with WorldBank population values
fbs_with_zeros <- fbs_with_zeros %>%
  left_join(world_bank_long,
            by = c("year", "iso3c")) %>%
  mutate(population = population.y) %>%
  select(-population.x, -population.y) %>%
  filter(!is.na(population))

# Add 0'ed out countries back into FBS population data
# population <- bind_rows(population,
#                         fbs_with_zeros
#                         )
```

```{r update per capita values}
# New FAO aquatic animals dataset
fao_new_aquatic <- update_population_data(fao_new_aquatic,
                                          animal_products = FALSE,
                                          historical = FALSE)
# Historical FAO aquatic animals dataset
fao_old_aquatic <- update_population_data(fao_old_aquatic,
                                          animal_products = FALSE,
                                          historical = TRUE)
# New FAO animals dataset
fao_new_raw <- update_population_data(fao_new_raw,
                       animal_products = TRUE,
                       historical = FALSE)
# Historical FAO animals dataset
fao_old_raw <- update_population_data(fao_old_raw,
                       animal_products = TRUE,
                       historical = TRUE)
```

```{r clean consumption data}
consumption_props <- consumption_full %>%
  group_by(year, consumer_iso3c, consumption_source, habitat, method) %>%
  summarise(consumption_live_t = sum(consumption_live_t)) %>%
  group_by(year, consumer_iso3c) %>%
  mutate(aquatic_source_prop = consumption_live_t/sum(consumption_live_t)) %>%
  select(-consumption_live_t) %>%
  ungroup()

# Test that all add back to 1
test <- consumption_props %>%
  group_by(year, consumer_iso3c) %>%
  summarise(test_val = sum(aquatic_source_prop)) %>%
  filter(abs(test_val-1) > 0.000001) 
```

```{r calculate percent of protein from aquatic animals}
fao_new_prop_aquatic <- fao_new_raw %>%
  # Filter to the total animal product protein supply
  filter(Element == "Protein supply quantity (g/capita/day)",
         Item == "Animal Products") %>%
  select("year", "iso3c", "data_source", "total_animal_protein" = "value") %>%
  # Join aquatic animal data and filter to product protein supply
  full_join(fao_new_aquatic %>%
              filter(Element == "Protein supply quantity (g/capita/day)") %>%
              select("year", "iso3c", "data_source", 
                     "aquatic_animal_protein" = "value"), 
            by = c("year", "iso3c", "data_source")) %>%
  mutate(value = aquatic_animal_protein/total_animal_protein,
         Element = "Proportion animal source protein from aquatic",
         Unit = "Proportion") %>%
  select(-total_animal_protein, -aquatic_animal_protein)

fao_old_prop_aquatic <- fao_old_raw %>%
  # Filter to the total animal product protein supply
  filter(Element == "Protein supply quantity (g/capita/day)",
         Item == "Animal Products") %>%
  select("year", "iso3c", "data_source", "total_animal_protein" = "value") %>%
  # Join aquatic animal data and filter to product protein supply
  full_join(fao_old_aquatic %>%
              filter(Element == "Protein supply quantity (g/capita/day)") %>%
              select("year", "iso3c", "data_source", 
                     "aquatic_animal_protein" = "value"), 
            by = c("year", "iso3c", "data_source")) %>%
  mutate(value = aquatic_animal_protein/total_animal_protein,  
         Element = "Proportion animal source protein from aquatic",
         Unit = "Proportion") %>%
  select(-total_animal_protein, -aquatic_animal_protein)

# Add proportion animal source protein from aquatic data to aquatic data frames and join all together
fao_aquatic <- fao_new_aquatic %>%
  bind_rows(fao_new_prop_aquatic) %>%
  bind_rows(fao_old_aquatic) %>%
  bind_rows(fao_old_prop_aquatic)

rm(list = c("fao_new_prop_aquatic", "fao_old_prop_aquatic"))
```

```{r disaggregate fbs measures}
fao_aquatic_source <- fao_aquatic %>%
  left_join(consumption_props, 
            by = c("year", "iso3c" = "consumer_iso3c"),
            # FIXIT: confirm this should be many-to-many
            relationship = "many-to-many") %>%
  # Disaggregate proportionately to ARTIS consumption sourcing
  mutate(value = value*aquatic_source_prop) %>%
  left_join(population, 
            by = c("year", "iso3c", "data_source"))

# FIXIT: Test is not currently working - seems to be related to country cleaning (e.g., China duplicates likely due to China vs China, Mainland)
tmp <- fao_aquatic_source %>% 
  group_by(year, iso3c, Element, data_source) %>%
  summarise(test = sum(aquatic_source_prop)) %>%
  filter(abs(test-1) > 0.0001)

# FIXIT: Test not passing, seemingly only for iso codes not in ARTIS. Check if this passes after new country standardization
tmp <- fao_aquatic_source %>%
  filter(is.na(value))

# FIXIT: For now, filter out missing values, but determine handling after confirming source of NAs
fao_aquatic_source <- fao_aquatic_source %>%
  filter(!is.na(value))

# Write final data output to .csv
# write_csv(fao_aquatic_source, "../output/fao_aquatic_source.csv")
```

```{r get data to Lana}
# fao_aquatic_source <- fao_aquatic_source %>% 
#   filter(!(year == 2010 & data_source == "old FBS"),
#          !(year == 2011 & data_source == "old FBS"),
#          !(year == 2012 & data_source == "old FBS"),
#          !(year == 2013 & data_source == "old FBS"),
#          data_source == "new FBS") %>%
#   rename(aa_reliance_prop = "value", consumption_prop = "aquatic_source_prop") %>%
#   relocate(aa_reliance_prop, .after = "consumption_prop")
# 
# write_csv(fao_aquatic_source, "../output/fao_aquatic_source_7_16_2025_lana.csv")
```