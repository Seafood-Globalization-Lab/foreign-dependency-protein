---
title: "02_results"
author: "Connor Quiroz and Jessica Gephart"
date: "2025-09-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(exploreARTIS)
library(cowplot)
library(ggrepel)
library(countrycode)
library(colorspace)
library(ggpubr)
library(arrow)
library(rstan)
```

# Chapter 1 Results

## Read in data

```{r load data}
# Read in population
population_fao_wb <- read.csv("../output/population_fao_wb.csv")

# Read in aquatic reliance data
aquatic_reliance <- read.csv("../output/fao_aquatic_reliance_source.csv") %>%
  left_join(population_fao_wb,by=c("year","iso3c"))%>%
  mutate(protein_consumed_kg_percap=protein_consumed_t*1000/population_fao)

# Read in FAO sourcing data
aquatic_fbs <- read.csv("../output/fao_fbs_aquatic_source.csv")

# Read in adaptive capacity data
# ac_df <- read_parquet("../data/e_s_ac_data_total.parquet") %>%
#   filter(scenario == "ssp126") %>%
#   select(-aa_reliance_pct, -scenario, -change_in_stock,-live_weight_t,-pct_change) %>%
#   rename(iso3c = "consumer_iso3c")
  
# Read in ecoregion data (all shapes associated with soverign)
ecoregion_full <- read.csv("../data/Spatially joined ecoregion to EEZ/ecoregion.csv") %>%
  rename("iso3c" = "ISO_SOV1",
         ecoregion = "ECOREGION",
         province = "PROVINCE",
         realm = "REALM",
         shape_area = "Shape_Area")

# Read in ecoregions for largest soverign shape
ecoregion_unique <- read.csv("../data/Spatially joined ecoregion to EEZ/ecoregion_clean.csv") %>%
  select(-FREQUENCY) %>%
  rename(iso3c = "ISO_SOV1",
         shape_area = "MAX_Shape_Area")

# Read in consumption data
# consumption <- read_parquet("C:/Users/cjqui/Desktop/SGL/Chapter 2 (trade climate risk)/trade-climate-risk/data/example_consumption_eez_2024_12_06.parquet") %>%
#   filter(year == 2019)

# Read in dietary sourcing flexibility index
dsfi_df <- read_csv("../data/covariates/food-systems-dashboard-2026-01-20 (dietary sourcing flexibility index).csv") %>%
  filter(`Start Year` == 2019 | `End Year` == 2019) %>%
  select(c("iso3c" = ISO3, "dsfi" = Value))

# Read in national indicator data
indicator_df <- read_csv("../data/covariates/all_national_indicators.csv")

# Read in coastline data
coastline_df <- read_csv("../data/covariates/countries-by-coastline-2026.csv") %>%
  mutate(iso3c = case_when(!is.na(flagCode) ~ countrycode(flagCode, origin = "iso2c", destination = "iso3c"),
                           country == "Namibia" ~ "NAM")) %>%
  select(c(iso3c, "coastline_km" = "CountryCoastlineKm"))

```

## Clean data

```{r clean  data}
# Join largest shape for the respective soverign country to their ecoregion names
ecoregion <- left_join(ecoregion_unique, ecoregion_full, by = c("iso3c", "shape_area"))

# Assign countries not associated with a marine ecoregion to "landlocked" code
landlocked_countries <- aquatic_reliance %>%
  distinct(iso3c) %>%
  drop_na() %>%
  filter(!iso3c %in% ecoregion$iso3c) %>%
  mutate(ecoregion = "landlocked",
         province = "landlocked",
         realm = "landlocked")

# Clean ecoregion data
ecoregion <- bind_rows(ecoregion, landlocked_countries) %>%
  arrange(iso3c) %>%
  select(-shape_area)

# Clean up files
rm(list = c("ecoregion_full", "ecoregion_unique"))


write_csv(ecoregion, "../output/ecoregion_clean.csv")

# Calculate total import weight for 2019
# imports_df <- consumption %>%
#   filter(year == 2019,
#          producer_iso3c != consumer_iso3c) %>%
#   group_by(consumer_iso3c) %>%
#   summarize(consumption_t = sum(consumption_t))
# 
# rm(consumption)
# gc()
```

World Wildlife Fund Report Figures

## Economic and dietary indicators of aquatic animal reliance

```{r acquire animal consumption data to be fed through analysis}
# Calculate animal consumption
animal_cons_cap <- aquatic_reliance %>%
  filter(year == 2019) %>%
  group_by(iso3c) %>%
  summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap))

# Calculate aquatic animal consumption
aquatic_animal_cons_cap <- aquatic_reliance %>%
  filter(year == 2019, food_group == "aquatic") %>%
  group_by(iso3c) %>%
  summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap))

# Calculate animal reliance consumption
aquatic_rel <- aquatic_animal_cons_cap %>%
  left_join(animal_cons_cap, by = "iso3c") %>%
  group_by(iso3c) %>%
  summarize(prop_animal_protein = protein_consumed_kg_percap.x / protein_consumed_kg_percap.y)

# Calculate aquatic animal consumption by sourcing and their respective reliances 
for (i in c("capture", "aquaculture", "domestic", "foreign", "marine", "inland")) {
  
  if (i %in% c("capture", "aquaculture")) {
    
    # Calculate per consumption per capita by method
    assign(
      paste0(i, "_cap"),
      aquatic_reliance %>%
        filter(year == 2019, food_group == "aquatic",
               method == i) %>%
        group_by(iso3c) %>%
        summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap))
    )
    
  }
  
  if (i %in% c("domestic", "foreign")) {
    
    # Calculate per consumption per capita by consumption source
    assign(
      paste0(i, "_cap"),
      aquatic_reliance %>%
        filter(year == 2019, food_group == "aquatic",
               consumption_source == i) %>%
        group_by(iso3c) %>%
        summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap))
    )
    
  }
  
  if (i %in% c("marine", "inland")) {
    
    # Calculate per consumption per capita by habitat
    assign(
      paste0(i, "_cap"),
      aquatic_reliance %>%
        filter(year == 2019, food_group == "aquatic",
               habitat == i) %>%
        group_by(iso3c) %>%
        summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap))
    )
    
  }
  
    # Calculate reliance by method, production source, or habitat
    assign(
      paste0(i, "_rel"),
      get(paste0(i,"_cap")) %>% # Get corresponding dataframe based on loop iteration i
         left_join(animal_cons_cap, by = "iso3c") %>%
         group_by(iso3c) %>%
         summarize(prop_animal_protein = protein_consumed_kg_percap.x / protein_consumed_kg_percap.y)
    )
    
    # Calculate production sources' proportion of total aquatic animal consumption per capita
    assign(
      paste0(i, "_prop_of_aquatic_cons"),
      get(paste0(i,"_cap")) %>% # Get corresponding dataframe based on loop iteration i
         left_join(aquatic_animal_cons_cap, by = "iso3c") %>%
         group_by(iso3c) %>%
         summarize(aquatic_source_prop = protein_consumed_kg_percap.x / protein_consumed_kg_percap.y)
    )
  
}

#calculate rate of change in aquatic protein quantity
aquatic_protein_roc <- aquatic_reliance %>%
  filter(data_source == "new FBS", food_group == "aquatic") %>%
  group_by(iso3c, year, method) %>%
  summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap, na.rm = TRUE)) %>%
  distinct() %>%
  filter(method == "capture") %>%
  split(.$iso3c) %>%
  map(~lm(protein_consumed_kg_percap~year, data = .x)) %>%
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  select(c("iso3c", "aquatic_estimate" = "estimate"))

#calculate rate of change in terrestrial protein quantity
terrestrial_protein_roc <- aquatic_reliance %>%
  filter(data_source == "new FBS", food_group == "terrestrial") %>%
  group_by(iso3c, year) %>%
  summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap, na.rm = TRUE)) %>%
  distinct() %>%
  split(.$iso3c) %>%
  map(~lm(protein_consumed_kg_percap~year, data = .x)) %>%
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  select(c("iso3c", "terrestrial_estimate" = "estimate"))
```

```{r}

capture_reliance <- %>%
  # left_join(ac_df, by = "iso3c") %>%
  left_join(ecoregion, by = "iso3c") %>%
  ungroup() %>%
  select(-year, -data_source) %>%
  add_region(col = "iso3c", region.col.name = "region") %>%
  left_join(dsfi_df, by = "iso3c") %>%
  left_join(imports_df %>% rename(iso3c = consumer_iso3c), by = "iso3c") %>%
  left_join(shannon_df %>% rename(iso3c = consumer_iso3c), by = "iso3c") %>%
  mutate(log_gdp = log(gdp),
         log_imports = log(consumption_t)) %>%
  left_join(indicator_df %>%
  select(c("eez_total", "iso3c", "inundation_area_log1000km2" = "inland_water_max")), by = "iso3c") %>%
  left_join(coastline_df, by = "iso3c") 

# Linear model
lm(protein_consumed_t ~ log(gdp) + gdp_trade + eez_total + inundation_area_log1000km2 + coastline_km, data = capture_reliance) %>%
  summary()

library(lme4)

# Mixed effects model
lmer(
  protein_consumed_t ~ log(gdp) + gdp_trade + eez_total + inundation_area_log1000km2 + coastline_km +
    (1 | realm),
  data = capture_reliance
) %>%
  summary()
```


### Hierarchical Bayesian model

```{r hierarchical model}
df <- capture_reliance %>%
  select(
    prop_animal_protein, realm, province, dsfi, log_gdp, log_imports
  ) %>%
  drop_na() %>%
  filter(realm != "")

X <- scale(df %>% select(-prop_animal_protein, -realm, -province))
y <- df$prop_animal_protein

# Create province index
realm_ids <- as.numeric(factor(df$realm))
n_realms <- length(unique(realm_ids))

N <- nrow(X)
K <- ncol(X)

inits <- function() {
  list(
    mu0 = 0,
    sigma0 = 1,
    alpha0 = 2,
    beta0 = 0.1,
    beta_0i = rep(0, n_realms),
    sigma_i = rep(1, n_realms),
    beta = rep(0, K)
  )
}

stan_data <- list(
  N = N,
  K = K,
  J = n_realms,  # number of provinces
  X = as.matrix(X),
  y = y,
  province = realm_ids  # province indicator for each observation
)

# Fit Bayesian model
fit <- stan(
  file = "../R/social_bayesian_model_hierarchical.stan",
  data = stan_data,
  init = inits, 
  chains = 3,
  iter = 10000,
  warmup = 2000
)
```

### Global level posteriors

```{r hierarcical global variable posteriors}
# Extract MCMC samples
x <- extract(fit, permuted = TRUE)
beta_global <- x$beta       # iter × K (slopes)

n_iter <- nrow(beta_global)
K <- ncol(beta_global)
vars <- colnames(X)

# Just the global slopes (no realm variation)
post_long_slopes <- expand_grid(
  iter = 1:n_iter,
  k = 1:K
) %>%
  mutate(
    value = map2_dbl(iter, k, ~beta_global[.x, .y]),
    var = vars[k]
  )

ci_df <- post_long_slopes %>%
  group_by(var) %>%
  summarise(
    lo95 = quantile(value, 0.025),
    lo50 = quantile(value, 0.25),
    med = quantile(value, 0.5),
    hi50 = quantile(value, 0.75),
    hi95 = quantile(value, 0.975),
    .groups = "drop"
  )

# Single plot (not faceted by realm since slopes are global)
ci_df %>%
  mutate(var = factor(var, levels = c("log_imports", "log_gdp", "dsfi"))) %>%
ggplot(aes(x = med, y = fct_reorder(var, med))) +
  geom_segment(aes(x = lo95, xend = hi95, yend = var)) +
  geom_segment(aes(x = lo50, xend = hi50, yend = var),
               linewidth = 2, color = "darkblue") +
  geom_point(size = 4, color = "black") +
  geom_point(size = 3, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(x = "Posterior median (50% and 95% credible intervals)",
       y = NULL) +
  theme_pubclean()
```

### Realm level intercepts

```{r look at realm specific intercepts}
# Posteriors of the realm intercepts
beta_0i <- x$beta_0i

# Different realm values
realm_levels <- levels(factor(df$realm))

post_intercepts <- expand_grid(
  iter = 1:n_iter,
  realm = 1:length(realm_levels)
) %>%
  mutate(
    value = map2_dbl(iter, realm, ~beta_0i[.x, .y]),
    realm = realm_levels[realm]
  )

# Caclulate credibility interval quantiles
ci_intercepts <- post_intercepts %>%
  group_by(realm) %>%
  summarise(
    lo95 = quantile(value, 0.025),
    lo50 = quantile(value, 0.25),
    med = quantile(value, 0.5),
    hi50 = quantile(value, 0.75),
    hi95 = quantile(value, 0.975),
    .groups = "drop"
  ) 

# Plot intercepts
ci_intercepts %>%
ggplot(aes(x = med, y = fct_reorder(realm, -med))) +
  geom_segment(aes(x = lo50, xend = hi50, yend = realm),
               linewidth = 2, color = "darkblue") +
  geom_segment(aes(x = lo95, xend = hi95, yend = realm)) +
  geom_point(size = 4, color = "black") +
  geom_point(size = 3, color = "white") +
  labs(x = "Realm-specific intercept", y = "Realm") +
  theme_pubclean() +
   geom_vline(xintercept = 0, linetype = "dashed")
```

## Aggregate aquatic reliance vs disaggregate aquatic reliance trends

```{r}
#################################################################
###   Calculate rate of change in aggregate animal reliance   ###
#################################################################

# Calculate aggregate global aquatic animal reliance
aa_reliance_mean_global_trends <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(food_group_total_protein_t = sum(protein_consumed_t)) %>%
  group_by(year, data_source) %>%
  mutate(prop_animal_protein = 100*food_group_total_protein_t/sum(food_group_total_protein_t)) %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"))

# Get slope coefficient and store in a data frame
aggregate_slope <- ({aa_reliance_mean_global_trends %>%
  filter(food_group == "aquatic", data_source == "new FBS") %>%
  lm(prop_animal_protein ~ year, data = .)}$coefficients[2]) %>%
  data.frame(estimate = ., consource_habitat_method = "aggregate") %>%
  remove_rownames()

aggregate_pos_countries <- aquatic_reliance %>%
  group_by(iso3c, year, data_source, food_group) %>%
  summarise(food_group_total_protein_t = sum(protein_consumed_t)) %>%
  group_by(year, data_source) %>%
  mutate(prop_animal_protein = 100*food_group_total_protein_t/sum(food_group_total_protein_t)) %>%
  split(.$iso3c) %>%
  map(~lm(prop_animal_protein~year, data = .x)) %>%
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == "year") %>%
  select(iso3c, estimate) %>%
  filter(estimate > 0) %>%
  summarize(num_countries = n()) %>% # Get the number of countries with positive slopes
  mutate(consource_habitat_method = "aggregate")

#################################################################
### Calculate rate of change in disaggregated animal reliance ###
#################################################################

# Calculate the total terrestrial animal protein consumed
 animal_protein_sourcing <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(animal_protein = sum(protein_consumed_t)) %>%
  filter(food_group == "terrestrial")

# Calculate the total aquatic animal protein consumed
 aquatic_protein_sourcing <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(aquatic_protein = sum(protein_consumed_t)) %>%
  filter(food_group == "aquatic")
 
 # Calculate total tonnage of combined terrestrial and aquatic animal protein
 total_protein <- left_join(animal_protein_sourcing, aquatic_protein_sourcing, by = c("year", "data_source")) %>%
   group_by(year, data_source) %>%
   summarize(total_protein = sum(animal_protein,aquatic_protein)) # add total aquatic animal protein (unseparated by sourcing) to animal proteins by year and data source
 
# Calculate disaggregated global aquatic animal reliance
disaggregated_slope <- aquatic_reliance %>%
  group_by(year, data_source, consumption_source, habitat, method, food_group) %>%
  summarise(food_group_total_protein_t = sum(protein_consumed_t)) %>%
  filter(food_group == "aquatic") %>%
  left_join(total_protein, by = c("year", "data_source")) %>%
  ungroup() %>%
  mutate(prop_animal_protein = 100 * (food_group_total_protein_t / total_protein)) %>% # Divide AA / TERRESTRIAL + AA
   filter(data_source == "new FBS") %>%
   group_by(consumption_source, habitat, method) %>% 
  nest() %>%
  mutate(model = map(data, ~lm(prop_animal_protein ~ year, data = .x)),
         tidy   = map(model, broom::tidy)) %>%
  unnest(tidy) %>%
  filter(term == "year") %>%
  select(consumption_source, habitat, method, estimate) %>%
  mutate(consource_habitat_method = paste(consumption_source, habitat, method, sep = " ")) %>%
  filter(!str_detect(consource_habitat_method, "unknown")) %>%
  ungroup() %>%
  select(estimate, consource_habitat_method)

#################################################################
###    Number of countries with positive slopes per group     ###
#################################################################

disaggregated_pos_countries <- aquatic_reliance %>%
  filter(data_source == "new FBS",
         food_group == "aquatic") %>%
  group_by(iso3c, consumption_source, habitat, method) %>% 
  nest() %>%
  mutate(model = map(data, ~lm(prop_animal_protein ~ year, data = .x)),
         tidy   = map(model, broom::tidy)) %>%
  unnest(tidy) %>%
  filter(term == "year") %>%
  select(iso3c, consumption_source, habitat, method, estimate) %>%
  filter(estimate > 0) %>%
  mutate(consource_habitat_method = paste(consumption_source, habitat, method, sep = " ")) %>%
  group_by(consumption_source, habitat, method) %>%
  mutate(num_countries = n()) %>% # Get the number of countries with positive slopes
  ungroup() %>%
  select(consource_habitat_method, num_countries) %>%
   distinct()


############################
### Compare slope values ###
############################

library(ggtext)
library(ggpubr)

df_plot <- bind_rows(aggregate_slope, disaggregated_slope) %>%
  left_join(
    disaggregated_pos_countries %>% bind_rows(aggregate_pos_countries),
    by = "consource_habitat_method"
  ) %>%
  mutate(
    consource_habitat_method = case_when(
      consource_habitat_method == "aggregate" ~
      "<b>aggregate</b>",
      .default = consource_habitat_method
    )
  )

ggplot(
  df_plot,
  aes(
    y    = fct_reorder(consource_habitat_method, -estimate),
    x    = estimate,
    fill = num_countries
  )
) +
  geom_col() +
  scale_y_discrete(
    labels = function(x) ifelse(
      x == "aggregate",
      "<b>aggregate</b>",
      x
    )
  ) +
  scale_fill_viridis_c(end = 0.8) +
  labs(
    x    = "Rate of change in/naquatic animal reliance (2010–2020)",
    y    = "Aquatic sourcing group",
    fill = "# countries w/ positive rate of change"
  ) +
  theme_pubclean() +
  theme(
    axis.text.y      = ggtext::element_markdown(size = 11),  # key change
    legend.position  = "bottom"
  )


rm(list = c("aggregate_slope", "disaggregated_slope", "aa_reliance_multiple_trends"))
```
```{r orthogonal analysis }
#calculate rate of change in aquatic protein quantity
aquatic_protein_quant <- aquatic_reliance %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"),
         data_source == "new FBS", food_group == "aquatic") %>%
  group_by(iso3c, year, method) %>%
  summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap, na.rm = TRUE)) %>%
  distinct() %>%
  filter(method == "capture") %>%
  split(.$iso3c) %>%
  map(~lm(protein_consumed_kg_percap~year, data = .x)) %>%
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  select(c("iso3c", "aquatic_estimate" = "estimate"))

#calculate rate of change in terrestrial protein quantity
terrestrial_protein_quant <- aquatic_reliance %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"),
         data_source == "new FBS", food_group == "terrestrial") %>%
  group_by(iso3c, year) %>%
  summarize(protein_consumed_kg_percap = sum(protein_consumed_kg_percap, na.rm = TRUE)) %>%
  distinct() %>%
  split(.$iso3c) %>%
  map(~lm(protein_consumed_kg_percap~year, data = .x)) %>%
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  select(c("iso3c", "terrestrial_estimate" = "estimate"))
#calculate rate of change in aquatic reliance
aquatic_protein_reliance <- aquatic_reliance %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"),
         data_source == "new FBS", food_group == "aquatic") %>%
  group_by(iso3c, year) %>%
  summarize(prop_animal_protein = sum(prop_animal_protein, na.rm = TRUE)) %>%
  distinct() %>%
  split(.$iso3c) %>%
  map(~lm(prop_animal_protein~year, data = .x)) %>%
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  select(c("iso3c", "aquatic_reliance_estimate" = "estimate"))
  
#join data 
joined_df <- aquatic_protein_quant %>%
  full_join(terrestrial_protein_quant, by="iso3c") %>%
  full_join(aquatic_protein_reliance, by="iso3c")
  

# Calculate orthogonal distance
  joined_df %>% mutate(
    orth_dist = (terrestrial_estimate - aquatic_estimate) / sqrt(2)
  ) %>%
    add_region(col = "iso3c", region.col.name = "region") %>%
    ggplot(aes(x = orth_dist, y = aquatic_reliance_estimate)) +
    geom_point() +
    geom_hline(yintercept = 0, linetype = "dashed", lwd = 0.75, alpha = 0.6) +
    geom_vline(xintercept = 0, linetype = "dashed", lwd = 0.75, alpha = 0.6) +
    theme_pubclean() +
    labs(x = "Orthogonal distance from 1:1 line", y = "Change in aquatic reliance (2010-2020)") +
    # facet_wrap(~ region, scales = "free") +
    guides(legend.position = "bottom") +
    scale_color_manual(values = artis_palette(6)) +
    theme(legend.position = "bottom")
```


