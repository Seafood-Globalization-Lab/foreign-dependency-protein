---
title: "02_results"
author: "Jessica Gephart"
date: "2025-09-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(exploreARTIS)
library(cowplot)
library(ggrepel)
library(countrycode)
```

```{r load data}
aquatic_reliance <- read.csv("../data/fao_aquatic_reliance_source.csv")
aquatic_fbs <- read.csv("../data/fao_fbs_aquatic_source.csv")
# Read in population data
population_fao_wb <- read.csv("../data/population_fao_wb.csv")
```

```{r}
aquatic_reliance %>%
  filter(year == 2020,
         food_group == "Aquatic") %>%
  mutate(habitat_method = paste(habitat, method)) %>%
  plot_bar(bar_group = "iso3c", fill_type = "habitat_method", 
           value = "aquatic_source_prop")

aquatic_reliance %>%
  filter(year == 2020,
         food_group == "Aquatic") %>%
  mutate(habitat_method = paste(habitat, method)) %>%
  plot_bar(bar_group = "iso3c", fill_type = "consumption_source", 
           value = "aquatic_source_prop")
```

```{r}
aquatic_reliance %>%
  filter(year == 2020, consumption_source == "foreign") %>%
  mutate(habitat_method = paste(habitat, method)) %>%
  plot_bar(bar_group = "iso3c", fill_type = "habitat_method", 
           value = "aquatic_source_prop", 
           top_n = 30)
```


```{r}
aquatic_reliance %>%
  filter(year == 2020,
         food_group == "Aquatic") %>%
  mutate(habitat_method = paste(habitat, method)) %>%
  plot_bar(bar_group = "iso3c", fill_type = "habitat_method",
           value = "prop_animal_protein", 
           top_n = 30)


aquatic_reliance %>%
  filter(year == 2020,
         food_group == "Aquatic") %>%
  mutate(habitat_method = paste(habitat, method)) %>%
  filter(habitat_method == "marine capture") %>%
  plot_bar(bar_group = "iso3c", fill_type = "habitat_method",
           value = "prop_animal_protein", 
           top_n = 30)
```

```{r global weighted mean reliance}
# Get population weights for each country
popn_weights <- population_fao_wb %>%
  group_by(year) %>%
  mutate(total_popn = sum(population_fao, na.rm = TRUE)) %>%
  group_by(year, iso3c) %>%
  summarize(weight = population_fao / total_popn)


(aa_reliance_mean_global_trends <- aquatic_reliance %>%
    # filter(food_group == "Aquatic") %>%
  group_by(year, iso3c, data_source, food_group) %>%
  summarise(prop_animal_protein = sum(prop_animal_protein)) %>%
  left_join(popn_weights, 
            by = c("year", "iso3c")) %>%
  #group_by(year, iso3c, data_source, food_group) %>%
  mutate(prop_animal_protein = prop_animal_protein * weight) %>%
  group_by(year, data_source, food_group) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein, na.rm = TRUE)) %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS")) %>%
  ggplot(aes(x = year, y = prop_animal_protein, linetype = data_source, color = food_group)) +
           geom_line(size = 1.1) +
  scale_color_manual(values = artis_palette(6)) +
  theme_light() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 8)) +
  labs(x = "",
       y = "Global animal protein reliance (%)",
       color = "Food group",
       linetype = "Data source") +
   ylim(0,84))

ggsave("../images/aa_reliance_mean_global_trends.jpg", plot = aa_reliance_mean_global_trends, device = "jpeg", units = "in", width = 5, height = 4)

```

```{r}
aa_reliance_mean_global_trends_alt <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(food_group_total_protein_t = sum(protein_consumed_t)) %>%
  group_by(year, data_source) %>%
  mutate(prop_animal_protein = 100*food_group_total_protein_t/sum(food_group_total_protein_t))

aa_reliance_mean_global_trends_alt %>%
  ggplot(aes(x = year, y = prop_animal_protein, 
             linetype = data_source, color = food_group)) +
  geom_line(size = 1.1) +
  scale_color_manual(values = artis_palette(6)) +
  theme_light() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 8)) +
  labs(x = "",
       y = "Global animal protein reliance (%)",
       color = "Food group",
       linetype = "Data source") +
   ylim(0,100)
  
```


```{r regional weighted mean reliance}
# Get population weights for each country
popn_weights_region <- population_fao_wb %>%
  add_region(col = "iso3c", region.col.name = "region") %>%
  group_by(year, region) %>%
  mutate(total_popn = sum(population_fao, na.rm = TRUE)) %>%
  group_by(year, iso3c) %>%
  summarize(weight = population_fao / total_popn)

(aa_reliance_mean_regional_trends <- aquatic_reliance %>%
  add_region(col = "iso3c", region.col.name = "region")  %>%
  filter(food_group == "Aquatic") %>%
  group_by(year, iso3c, region, data_source) %>%
  summarize(prop_animal_protein = sum(prop_animal_protein, na.rm = TRUE)) %>%
   distinct() %>%
  left_join(popn_weights_region, by = c("year", "iso3c")) %>%
  group_by(year, iso3c, region, data_source) %>%  # And here
  mutate(prop_animal_protein = prop_animal_protein * weight) %>%
  group_by(year, region, data_source) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein, na.rm = TRUE)) %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS")) %>%
  ggplot(aes(x = year, y = prop_animal_protein, color = region, linetype = data_source)) +
           geom_line(size = 1.1) +
  scale_color_manual(values = artis_palette(6)) +
  theme_light() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.2, 'cm'),
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 8)) +
  labs(x = "",
       y = "Regional AA reliance (%)",
       color = "Region",
       linetype = "Data source"))

# a <- data %>%
#   filter(food_group == "Aquatic") %>%
#   ggplot(aes(x = year, y = prop_animal_protein, color = region, linetype = data_source)) +
#            geom_line(size = 1.1, alpha = 0.5) +
#   scale_color_manual(values = artis_palette(6)) +
#   theme_light() +
#   theme(legend.position = "bottom",
#         legend.key.size = unit(0.2, 'cm'),
#         legend.text = element_text(size = 6),
#         legend.title = element_text(size = 8)) +
#   labs(x = "",
#        y = "Regional AA reliance (%)",
#        color = "Region",
#        linetype = "Data source") +
#   ylim(0,25)
# 
# b <- data %>%
#   filter(food_group == "Terrestrial") %>%
#   ggplot(aes(x = year, y = prop_animal_protein, color = region, linetype = data_source)) +
#            geom_line(size = 1.1, alpha = 0.5) +
#   scale_color_manual(values = artis_palette(6)) +
#   theme_light() +
#   theme(legend.position = "bottom",
#         legend.key.size = unit(0.2, 'cm'),
#         legend.text = element_text(size = 6),
#         legend.title = element_text(size = 8)) +
#   labs(x = "",
#        y = "Regional AA reliance (%)",
#        color = "Region",
#        linetype = "Data source") +
#   ylim(0,95)

# Look at reliance by region
# (aa_reliance_mean_regional_trends <- aquatic_reliance %>%
#   ggplot(aes(x = year, y = prop_animal_protein, color = region, linetype = data_source, opacity = food_group)) +
#            geom_line(size = 1.1) +
#     geom_point(aes(shape = food_group)) +
#   scale_color_manual(values = artis_palette(6)) +
#   theme_light() +
#   theme(legend.position = "bottom",
#         legend.key.size = unit(0.2, 'cm'),
#         legend.text = element_text(size = 6),
#         legend.title = element_text(size = 8)) +
#   labs(x = "",
#        y = "Regional AA reliance (%)",
#        color = "Region",
#        linetype = "Data source"))

ggsave("../images/aa_reliance_mean_regional_trends.jpg", plot = aa_reliance_mean_regional_trends, device = "jpeg", units = "in", width = 5, height = 4)
```

```{r global weighted mean reliance by sourcing}
# Look at aquatic animal reliance by sourcing
(aa_reliance_multiple_trends <- aquatic_reliance %>%
    filter(food_group == "Aquatic") %>%
  group_by(year, iso3c, data_source, habitat, method, consumption_source) %>%
  summarize(prop_animal_protein = sum(prop_animal_protein, na.rm = TRUE)) %>%
  left_join(popn_weights, by = c("year", 
                                 "iso3c")) %>%
  group_by(year, iso3c, data_source, habitat, method, consumption_source) %>%
  summarize(prop_animal_protein = prop_animal_protein * weight) %>%
  group_by(year, data_source, habitat, method, consumption_source) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein, na.rm = TRUE)) %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"),
         !is.na(consumption_source),
         method != "unknown") %>%
  ggplot(aes(x = year, y = prop_animal_protein, color = consumption_source, linetype = data_source)) +
           geom_line(size = 0.9) +
  scale_color_manual(values = artis_palette(3)) +
  theme_light() +
  facet_wrap(habitat ~ method) +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 6,
                                 angle = 45),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 5)) +
  labs(linetype = "Consumption source",
       color = "Data source",
       x = "",
       y = "Aquatic animal Reliance (%)"))

ggsave("../images/aa_reliance_multiple_trends.jpg", plot = aa_reliance_multiple_trends, device = "jpeg", units = "in", width = 5, height = 4)
```

```{r}
source("../R/create_map.R")

(a <- aquatic_reliance %>%
  filter(year == 2020,
         food_group == "Aquatic") %>%
  group_by(iso3c) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein)) %>%
  create_map(fill = "prop_animal_protein", country.col.name = "iso3c") +
  labs(fill = "AA reliance (%)",
       tag = "A") +
    theme(legend.key.size = unit(0.3, 'cm'),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 5.5)))

(b <- aquatic_reliance %>%
  filter(method == "capture",
         habitat == "marine",
         year == 2020,
         food_group == "Aquatic") %>%
  group_by(iso3c) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein)) %>%
  create_map(fill = "prop_animal_protein", country.col.name = "iso3c") +
  labs(fill = "AA marine capture reliance (%)",
       tag = "B") +
    theme(legend.key.size = unit(0.3, 'cm'),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 5.5)))


(aa_reliance_chloropleth <- plot_grid(a, b, align = "v"))
  

ggsave("../images/aa_reliance_chloropleth.jpg", plot = aa_reliance_chloropleth, device = "jpeg", units = "in", width = 5, height = 2)
```
  
```{r}
# Distribution of protein reliance
(aa_reliance_histogram <- aquatic_reliance %>%
  filter(year == 2020,
         food_group == "Aquatic") %>%
   mutate(prop_animal_protein = prop_animal_protein * 100) %>%
  ggplot(aes(x = prop_animal_protein, fill = consumption_source)) +
  geom_histogram(alpha = 0.5, color = "black",position = "identity") +
  facet_wrap(habitat ~ method) +
  theme_light() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = artis_palette(3)) +
  labs(x = "AA reliance (%)", y = "Number of countries",
       fill = "Consumption source"))

ggsave("../images/aa_reliance_histogram.jpg", plot = aa_reliance_histogram, device = "jpeg", units = "in", width = 5, height = 4)
```

```{r}
# Define the circle theme
circle_theme <- theme(axis.line=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks=element_blank(),
                      axis.title.x=element_blank(),
                      axis.title.y=element_blank(),
                      # legend.position="left",
                      legend.position = "none",
                      panel.background=element_blank(),
                      panel.border=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank(),
                      axis.text.x = element_blank()) 

# Prepare the data
aquatic_plot_data <- aquatic_reliance %>%
  filter(habitat != "unknown") %>%
  mutate(
    # Create a combined category for the legend
    fill_category = paste(consumption_source, habitat, method, sep = " - "),
    # Clean up the category names for better readability
    fill_category = case_when(
      fill_category == "domestic - inland - aquaculture" ~ "Domestic Inland Aquaculture",
      fill_category == "domestic - inland - capture" ~ "Domestic Inland Capture",
      fill_category == "foreign - inland - aquaculture" ~ "Foreign Inland Aquaculture", 
      fill_category == "foreign - inland - capture" ~ "Foreign Inland Capture",
      fill_category == "foreign - marine - aquaculture" ~ "Foreign Marine Aquaculture",
      fill_category == "foreign - marine - capture" ~ "Foreign Marine Capture",
      TRUE ~ fill_category
    )
  ) %>%
  filter(food_group == "Aquatic",
         year == 2020) %>%
  group_by(iso3c) %>%
  mutate(total_reliance = sum(prop_animal_protein)) %>%
  filter(total_reliance > 0.15) %>%
  # Order countries by total reliance for better visualization
  arrange(desc(total_reliance)) %>%
  ungroup() %>%
  mutate(iso3c = factor(iso3c, levels = unique(iso3c))) %>%
  mutate(iso3c = countrycode(iso3c, origin = "iso3c", destination = "country.name"))
  

# Create labels dataframe for country names
aquatic_labels_df <- aquatic_plot_data %>%
  group_by(iso3c) %>%
  summarise(
    total_reliance = first(total_reliance),
    .groups = 'drop'
  ) %>%
  arrange(desc(total_reliance)) %>%
  mutate(
    iso3c = factor(iso3c, levels = iso3c),
    # Calculate angles for text positioning
    country_num = as.numeric(iso3c),
    n_countries = n(),
    angle = 90 - (country_num - 1) * 360 / n_countries,
    # Adjust text justification based on angle
    hjust = ifelse(angle > 90 | angle < -90, 1, 0),
    # Flip text that would be upside down
    angle = ifelse(angle > 90 | angle < -90, angle + 180, angle)
  )

# Create the circular plot
a <- aquatic_plot_data %>%
  ggplot(aes(x = iso3c, y = prop_animal_protein, fill = fill_category)) +
  geom_col(stat = "identity", position = "stack", width = 0.8) +
  # Add inner and outer circle boundaries (similar to geom_errorbar in your example)
  geom_errorbar(aes(
    x = 1, 
    ymin = -0.01,  # Inner circle size
    ymax = 0.01),  # Adjust this to control spacing from center
    alpha = 0) +
  # Add country labels
  geom_text(data = aquatic_labels_df,
            aes(x = iso3c,
                y = total_reliance + 0.05, # Position labels outside the bars
                label = iso3c,
                angle = angle,
                hjust = hjust), 
            inherit.aes = FALSE,
            fontface = "bold",
            alpha = 0.9,
            size = 2,
            color = "grey40") +
  # Use your artis_palette if available, otherwise use Set3
  scale_fill_manual(values = artis_palette(8)) +
  coord_polar(theta = "x", start = 0) +
  # Set y-axis limits to create proper inner circle
  ylim(-0.15, max(aquatic_labels_df$total_reliance) + 0.1) +
  circle_theme

top_10_reliance_countries <- aquatic_plot_data %>%
  distinct(iso3c, total_reliance) %>%
  arrange(-total_reliance) %>%
  top_n(15) %>%
  pull(iso3c)


b_with_legend <- aquatic_plot_data %>%
  filter(iso3c %in% top_10_reliance_countries) %>%
  mutate(prop_animal_protein = 100 * prop_animal_protein) %>%
  ggplot(aes(x = prop_animal_protein, y = fct_reorder(iso3c, desc(-total_reliance)), fill = fill_category)) +
  geom_col() +
  scale_fill_manual(values = artis_palette(8)) +
  theme_light() +
  labs(x = "Aquatic animal reliance %", fill = "Sourcing", y = "Country ISO3 code") +
  theme(legend.position = "bottom",
        legend.key.size = unit(4, "mm"),
        legend.text = element_text(size = 5))

# Extract the legend from plot b
legend <- get_plot_component(b_with_legend, "guide-box-bottom", return_all = TRUE)
  

# Create plot b WITHOUT legend
b <- aquatic_plot_data %>%
  filter(iso3c %in% top_10_reliance_countries) %>%
  mutate(prop_animal_protein = 100 * prop_animal_protein) %>%
  ggplot(aes(x = prop_animal_protein, y = fct_reorder(iso3c, desc(-total_reliance)), fill = fill_category)) +
  geom_col() +
  scale_fill_manual(values = artis_palette(8)) +
  theme_light() +
  labs(x = "AA reliance %", y = "", fill = "Sourcing") +
  theme(legend.position = "none",
        axis.title.y = element_blank())  # Remove legend from this plot

# Combine plots: a and b in top row, legend in bottom row
(aquatic_reliance_sourcing <- plot_grid(
  plot_grid(a, b, ncol = 2, labels = c("A", "B")), # Top row with both plots
  legend,                                           # Bottom row with legend
  ncol = 1,                                        # Arrange in single column
  rel_heights = c(1, 0.1)                         # Adjust relative heights (plots vs legend)
))


ggsave("../images/aquatic_reliance_sourcing.jpg", plot = aquatic_reliance_sourcing, device = "jpeg", units = "in", width = 6, height = 4)
```


```{r summary stats}
# Percetnage of aquatic animal protein global reliance
aquatic_reliance %>%
    filter(food_group == "Aquatic") %>%
  group_by(year, iso3c, data_source) %>%
  summarize(prop_animal_protein = sum(prop_animal_protein, na.rm = TRUE)) %>%
  left_join(popn_weights, by = c("year", 
                                 "iso3c")) %>%
   group_by(year, iso3c, data_source) %>%
  summarize(prop_animal_protein = prop_animal_protein * weight) %>%
   group_by(year, data_source) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein, na.rm = TRUE)) %>%
  filter(year == 2020)
```

```{r}
# Calculate rate of change in marine capture reliance
marine_capture <- aquatic_reliance %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"),
         data_source == "new FBS", food_group == "Aquatic",
         method == "capture") %>%
  group_by(iso3c, year) %>%
  summarize(prop_animal_protein = case_when(
    food_group == "Aquatic" ~ sum(prop_animal_protein, na.rm = TRUE),
    food_group == "Terrestrial" ~ mean(prop_animal_protein, na.rm = TRUE)
  ), .groups = "drop") %>%
  distinct() %>%
  split(.$iso3c) %>% 
  map(~lm(prop_animal_protein~year, data = .x)) %>% 
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  mutate(food_group = "Aquatic") %>%
  select(c("iso3c", "aquatic_estimate" = "estimate"))

# Calculate rate of change in aquaculture reliance
aquaculture <- aquatic_reliance %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS"),
         data_source == "new FBS", food_group == "Aquatic",
         method == "aquaculture") %>%
  group_by(iso3c, year) %>%
  summarize(prop_animal_protein = case_when(
    food_group == "Aquatic" ~ sum(prop_animal_protein, na.rm = TRUE),
    food_group == "Terrestrial" ~ mean(prop_animal_protein, na.rm = TRUE)
  ), .groups = "drop") %>%
  distinct() %>%
  split(.$iso3c) %>% 
  map(~lm(prop_animal_protein~year, data = .x)) %>% 
  map_df(broom::tidy, .id = 'iso3c') %>%
  filter(term == 'year') %>%
  mutate(food_group = "Terrestrial") %>%
  select(c("iso3c", "terrestrial_estimate" = "estimate"))

# Plot rate of change in aquaculture reliance vs marine capture reliance
(reliance_roc <- marine_capture %>%
  add_region(col = "iso3c", region.col.name = "region") %>%
  left_join(aquaculture, by = "iso3c") %>%
  ggplot(aes(x = aquatic_estimate, y = terrestrial_estimate, label = iso3c)) +
  geom_point(size = 0.8) +
  facet_wrap(~ region) +
  geom_hline(yintercept = 0, linetype = "dashed", lwd = 0.75, alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed", lwd = 0.75, alpha = 0.6) +
  geom_text_repel(size = 2) +
  geom_rug() +
  scale_color_manual(values = artis_palette(6)) +
  labs(x = "Change in marine capture reliance (2010-2020)", y = "Change in aquaculture relaince (2010-2020)") +
  theme_light() +
  theme(axis.text = element_text(size = 5)) +
  guides(color = "none"))


ggsave("../images/reliance_roc.jpg", plot = reliance_roc, device = "jpeg", units = "in", width = 5, height = 4)
```
```{r}
aquatic_reliance_ranks <- aquatic_reliance %>%
  filter(food_group == "Aquatic", year == 2019) %>%
  group_by(iso3c) %>%
  summarise(prop_animal_protein_total = sum(prop_animal_protein)) %>%
  arrange(desc(prop_animal_protein_total)) %>%
  mutate(total_rank = rank(-prop_animal_protein_total)) %>%
  left_join(aquatic_reliance %>%
  filter(food_group == "Aquatic", method == "capture", habitat == "marine", year == 2019) %>%
  group_by(iso3c) %>%
  summarise(prop_animal_protein_marine = sum(prop_animal_protein)) %>%
  arrange(desc(prop_animal_protein_marine)) %>%
  mutate(marine_capture_rank = rank(-prop_animal_protein_marine)), 
         by = "iso3c")


aquatic_reliance_ranks %>%
  ggplot(aes(x = total_rank, y = marine_capture_rank, label = iso3c)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_text_repel()


a <- aquatic_reliance_ranks %>%
  plot_bar(bar_group = "iso3c", value = "prop_animal_protein_total",
           top_n = 15, 
           plot.title = "Total aquatic reliance")

b <- aquatic_reliance_ranks %>%
  plot_bar(bar_group = "iso3c", value = "prop_animal_protein_marine", 
           top_n = 15, 
           plot.title = "Marine reliance")

ggarrange(a, b)

```

