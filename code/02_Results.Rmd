---
title: "02_results"
author: "Connor Quiroz and Jessica Gephart"
date: "2025-09-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(exploreARTIS)
library(cowplot)
library(ggrepel)
library(countrycode)
library(colorspace)
library(ggpubr)
```

# World Wildlife Fund Report Figures

```{r load data}
# Read in FAO sourcing / reliance data
aquatic_reliance <- read.csv("../output/fao_aquatic_reliance_source.csv")
aquatic_fbs <- read.csv("../output/fao_fbs_aquatic_source.csv")

# Read in population
population_fao_wb <- read.csv("../output/population_fao_wb.csv")
```

## Figure 1

```{r}
aa_reliance_mean_global_trends_alt <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(food_group_total_protein_t = sum(protein_consumed_t)) %>%
  group_by(year, data_source) %>%
  mutate(prop_animal_protein = 100*food_group_total_protein_t/sum(food_group_total_protein_t)) %>%
  filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS")) # Remove overlapping years, prioritizing new years

aa_reliance_mean_global_trends <- aa_reliance_mean_global_trends_alt %>%
  mutate(food_group = factor(food_group, levels = c("terrestrial", "aquatic"))) %>%
  ggplot(aes(x = year, y = prop_animal_protein)) +
  geom_area(aes(fill = food_group)) +
  scale_fill_manual(values = c(desaturate("#AA3C3B", 0.4),"#3D8A8D")) +
  theme_light() +
  theme(
    legend.position = "bottom",
    legend.key.size = unit(0.3, 'cm'),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6),
    axis.text = element_text(size = 5),
    axis.title = element_text(size = 6),
    legend.box = "vertical",                    # Stack legends vertically
  legend.spacing = unit(0.1, "cm"),           # Reduce space between legend items
  legend.margin = margin(t = 0, b = 0),       # Remove top/bottom margin around legend box
  legend.box.margin = margin(t = -2, b = -2)  # Pull stacked legends closer together

  ) + labs(x = "",
       y = "Global animal protein reliance (%)",
       fill = "Food group")


# Calculate the total terrestrial animal protein
 animal_protein_sourcing <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(animal_protein = sum(protein_consumed_t)) %>%
  filter(food_group == "terrestrial")

# Calculate the total aquatic animal protein
 aquatic_protein_sourcing <- aquatic_reliance %>%
  group_by(year, data_source, food_group) %>%
  summarise(aquatic_protein = sum(protein_consumed_t)) %>%
  filter(food_group == "aquatic")
 
 # Calculate total tonnage of combined terrestrial and aquatic animal protein
 total_protein <- left_join(animal_protein_sourcing, aquatic_protein_sourcing, by = c("year", "data_source")) %>%
   group_by(year, data_source) %>%
   summarize(total_protein = sum(animal_protein,aquatic_protein)) # add total aquatic animal protein (unseparated by sourcing) to animal proteins by year and data source
 
# Join total protein to aquatic protein weights separated by protein to calculate reliance by sourcing
 aa_reliance_multiple_trends_alt <- aquatic_reliance %>%
  group_by(year, data_source, consumption_source, habitat, method, food_group) %>%
  summarise(food_group_total_protein_t = sum(protein_consumed_t)) %>%
  filter(food_group == "aquatic") %>%
  left_join(total_protein, by = c("year", "data_source")) %>%
  ungroup() %>%
  mutate(prop_animal_protein = 100 * (food_group_total_protein_t / total_protein)) %>% # Divide AA / TERRESTRIAL + AA
  filter(habitat != "unknown") %>%
   filter(!(year %in% c(2010, 2011, 2012, 2013) & data_source == "old FBS")) # Remove overlapping years, prioritizing new years
 
 
 aa_reliance_multiple_trends_alt_1 <- aa_reliance_multiple_trends_alt %>%
  mutate(habitat = str_to_title(habitat)) %>%
  mutate(habitat_method = paste(habitat, method, sep = " "))

 
# Artis palette
artis_colors <- artis_palette(3)

artis_colors <- artis_colors[c(2,1)]
 
aa_reliance_multiple_trends <- aa_reliance_multiple_trends_alt_1 %>%
  ggplot(aes(x = year, y = prop_animal_protein, fill = consumption_source)) +
  geom_area(size = 0.75) +
  
  scale_fill_manual(values = artis_colors) +
  theme_light() +
  facet_wrap(~ habitat_method) +  # Single-line facet labels
  theme(
    legend.position = "bottom",
    legend.key.size = unit(0.3, 'cm'),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6),
    axis.text = element_text(size = 5),
    axis.title = element_text(size = 6),
    strip.text = element_text(size = 5),
    axis.text.x = element_text(size = 4.5, angle = 30),
    legend.box = "vertical",
    legend.spacing = unit(0.1, "cm"),
    legend.margin = margin(t = 0, b = 0),
    legend.box.margin = margin(t = -2, b = -2)
  ) +
  labs(
    fill = "Consumption source",
    x = "",
    y = "Aquatic animal Reliance (%)"
  )



(aa_reliance_mean_global_trends_plot <- plot_grid(
  aa_reliance_mean_global_trends,
  aa_reliance_multiple_trends,
  ncol = 2,
  rel_heights = c(0.8, 2.2),  # Give more space to the faceted plot
  labels = c("A", "B"),
  label_size = 10
))




ggsave("../images/aa_reliance_mean_global_trends.jpg", plot = aa_reliance_mean_global_trends_plot, device = "jpeg", units = "in", width = 5, height = 3)
```

## Figure 2

```{r Shell plot}
# Define the circle theme
circle_theme <- theme(axis.line=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks=element_blank(),
                      axis.title.x=element_blank(),
                      axis.title.y=element_blank(),
                      # legend.position="left",
                      legend.position = "none",
                      panel.background=element_blank(),
                      panel.border=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank(),
                      axis.text.x = element_blank()) 

# Prepare the data
aquatic_plot_data <- aquatic_reliance %>%
  filter(habitat != "unknown") %>%
  mutate(
    # Create a combined category for the legend
    fill_category = paste(consumption_source, habitat, method, sep = " - "),
    # Clean up the category names for better readability
    fill_category = case_when(
      fill_category == "domestic - inland - aquaculture" ~ "Domestic inland aquaculture",
      fill_category == "domestic - inland - capture" ~ "Domestic inland capture",
      fill_category == "domestic - marine - capture" ~ "Domestic marine capture",
      fill_category == "domestic - marine - aquaculture" ~ "Domestic marine aquaculture",
      fill_category == "foreign - inland - aquaculture" ~ "Foreign inland aquaculture", 
      fill_category == "foreign - inland - capture" ~ "Foreign inland capture",
      fill_category == "foreign - marine - aquaculture" ~ "Foreign marine aquaculture",
      fill_category == "foreign - marine - capture" ~ "Foreign marine capture",
      TRUE ~ fill_category
    ),
    fill_category = factor(fill_category, levels = c("Domestic marine capture",
                                                     "Foreign marine capture",
                                                     "Domestic inland capture",
                                                     "Foreign inland capture",
                                                     "Domestic marine aquaculture",
                                                     "Foreign marine aquaculture",
                                                     "Domestic inland aquaculture",
                                                     "Foreign inland aquaculture"))) %>%
  filter(food_group == "aquatic",
         year == 2019) %>%
  group_by(iso3c) %>%
  mutate(total_reliance = sum(prop_animal_protein)) %>%
  filter(total_reliance > 0.15) %>%
  # Order countries by total reliance for better visualization
  arrange(desc(total_reliance)) %>%
  ungroup() %>%
  mutate(iso3c = factor(iso3c, levels = unique(iso3c))) %>%
  mutate(iso3c = countrycode(iso3c, origin = "iso3c", destination = "country.name"))

# Get top 15 countries for the bar chart
top_15_reliance_countries <- aquatic_plot_data %>%
  distinct(iso3c, total_reliance) %>%
  arrange(-total_reliance) %>%
  slice_head(n = 15) %>%
  pull(iso3c)

# Filter data for the circular plot (countries ranked 16th and below)
aquatic_plot_data_circle <- aquatic_plot_data %>%
  filter(!iso3c %in% top_15_reliance_countries) %>%
  # Re-order the remaining countries for the circular plot
  arrange(desc(total_reliance)) %>%
  mutate(iso3c = factor(iso3c, levels = unique(iso3c)))

# Create labels dataframe for country names (for circular plot only)
aquatic_labels_df <- aquatic_plot_data_circle %>%
  group_by(iso3c) %>%
  summarise(
    total_reliance = first(total_reliance),
    .groups = 'drop'
  ) %>%
  arrange(desc(total_reliance)) %>%
  mutate(
    iso3c = factor(iso3c, levels = iso3c),
    # Calculate angles for text positioning
    country_num = as.numeric(iso3c),
    n_countries = n(),
    angle = 90 - (country_num - 1) * 360 / n_countries,
    # Adjust text justification based on angle
    hjust = ifelse(angle > 90 | angle < -90, 1, 0),
    # Flip text that would be upside down
    angle = ifelse(angle > 90 | angle < -90, angle + 180, angle)
  )


mc_1 <- "#741A32"
mc_2 <- "#C06233"
  
mc_3 <- "#A13632"
mc_4 <- lighten(mc_3, amount = .25)

aq_1 <- "#114F59"
aq_2 <-lighten(aq_1, amount = .4)

aq_3 <- "#3D8A8D"
aq_4 <- lighten(aq_3, amount = .5)

shell_palette <- c(mc_1,mc_2,mc_3,mc_4,aq_1,aq_2,aq_3,aq_4)

# Create the circular plot (for countries ranked 16th and below)
a <- aquatic_plot_data_circle %>%
  ggplot(aes(x = iso3c, y = prop_animal_protein, fill = fill_category)) +
  geom_col(stat = "identity", position = "stack", width = 0.8) +
  # Add inner and outer circle boundaries
  geom_errorbar(aes(
    x = 1, 
    ymin = -0.01,  # Inner circle size
    ymax = 0.01),  # Adjust this to control spacing from center
    alpha = 0) +
  # Add country labels
  geom_text(data = aquatic_labels_df,
            aes(x = iso3c,
                y = total_reliance + 0.05, # Position labels outside the bars
                label = iso3c,
                angle = angle,
                hjust = hjust), 
            inherit.aes = FALSE,
            fontface = "bold",
            alpha = 0.9,
            size = 2,
            color = "grey40") +
  # Use your artis_palette if available, otherwise use Set3
  scale_fill_manual(values = shell_palette) +
  coord_polar(theta = "x", start = 0) +
  # Set y-axis limits to create proper inner circle
  ylim(-0.15, max(aquatic_labels_df$total_reliance) + 0.1) +
  circle_theme

# Create plot b WITH legend (for top 15 countries)
b_with_legend <- aquatic_plot_data %>%
  filter(iso3c %in% top_15_reliance_countries) %>%
  mutate(prop_animal_protein = 100 * prop_animal_protein) %>%
  ggplot(aes(x = prop_animal_protein, y = fct_reorder(iso3c, desc(-total_reliance)), fill = fill_category)) +
  geom_col() +
  scale_fill_manual(values = shell_palette) +
  theme_light() +
  labs(x = "Aquatic animal reliance %", fill = "Sourcing", y = "Country ISO3 code") +
  theme(legend.position = "bottom",
        legend.key.size = unit(4, "mm"),
        legend.text = element_text(size = 5))

# Extract the legend from plot b
legend <- get_plot_component(b_with_legend, "guide-box-bottom", return_all = TRUE)

# Create plot b WITHOUT legend (for top 15 countries)
b <- aquatic_plot_data %>%
  filter(iso3c %in% top_15_reliance_countries) %>%
  mutate(prop_animal_protein = 100 * prop_animal_protein) %>%
  ggplot(aes(x = prop_animal_protein, y = fct_reorder(iso3c, desc(-total_reliance)), fill = fill_category)) +
  geom_col() +
  scale_fill_manual(values = shell_palette) +
  theme_light() +
  labs(x = "AA reliance %", y = "", fill = "Sourcing") +
  theme(legend.position = "none",
        axis.title.y = element_blank())

# Combine plots: a and b in top row, legend in bottom row
(aquatic_reliance_sourcing <- plot_grid(
  plot_grid(b, a, ncol = 2, labels = c("A", "B")), # Top row with both plots
  legend,                                           # Bottom row with legend
  ncol = 1,                                        # Arrange in single column
  rel_heights = c(1, 0.15)                         # Adjust relative heights (plots vs legend)
))

ggsave("../images/aquatic_reliance_sourcing.jpg", plot = aquatic_reliance_sourcing, device = "jpeg", units = "in", width = 6, height = 4)
```

## Figure 3
  
```{r chloropleth map}
# Load in script for creating maps
source("../R/create_map.R")

global_limits <- aquatic_reliance %>%
  filter(year == 2020, food_group == "aquatic") %>%
  summarize(
    min_val = 100 * min(prop_animal_protein, na.rm = TRUE),
    max_val = 100 * max(prop_animal_protein, na.rm = TRUE)
  )

min_val <- global_limits$min_val
max_val <- global_limits$max_val

# generate both maps with identical color limits
a <- aquatic_reliance %>%
  filter(year == 2020,
         food_group == "aquatic",
         consumption_source == "foreign") %>%
  group_by(iso3c) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein)) %>%
  create_map(fill = "prop_animal_protein", country.col.name = "iso3c") +
  scale_fill_viridis_c(option = "plasma", limits = c(min_val, max_val)) +
  labs(fill = "Aquatic animal protein reliance (%)",
       tag = "A") +
  theme(legend.key.size = unit(0.3, 'cm'),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 5.5))

b <- aquatic_reliance %>%
  filter(method == "capture",
         habitat == "marine",
         year == 2020,
         food_group == "aquatic") %>%
  group_by(iso3c) %>%
  summarize(prop_animal_protein = 100 * sum(prop_animal_protein)) %>%
  create_map(fill = "prop_animal_protein", country.col.name = "iso3c") +
  scale_fill_viridis_c(option = "plasma", limits = c(min_val, max_val)) +
  labs(fill = "Aquatic animal protein reliance (%)",
       tag = "B") +
  theme(legend.key.size = unit(0.3, 'cm'),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 5.5))

# combine without duplicating legends
aa_reliance_chloropleth <- plot_grid(
  a + theme(legend.position = "none"),
  b + theme(legend.position = "none"),
  align = "v"
)

# extract one shared legend and append it below
legend <- get_legend(a)
(aa_reliance_chloropleth <- plot_grid(aa_reliance_chloropleth, legend, ncol = 1, rel_heights = c(1, 0.1)))

ggsave("../images/aa_reliance_chloropleth.jpg", plot = aa_reliance_chloropleth, device = "jpeg", units = "in", width = 5, height = 2.5)
```

## Figure 4

```{r}
# Rank countries by marine capture aquatic animal reliance and by their total aquatic animal reliance
aquatic_reliance_ranks <- aquatic_reliance %>%
  filter(food_group == "aquatic", year == 2019) %>%
  group_by(iso3c) %>%
  summarise(prop_animal_protein_total = sum(prop_animal_protein)) %>%
  arrange(desc(prop_animal_protein_total)) %>%
  mutate(total_rank = rank(-prop_animal_protein_total)) %>%
  left_join(aquatic_reliance %>%
  filter(food_group == "aquatic", method == "capture", habitat == "marine", year == 2019) %>%
  group_by(iso3c) %>%
  summarise(prop_animal_protein_marine = sum(prop_animal_protein)) %>%
  arrange(desc(prop_animal_protein_marine)) %>%
  mutate(marine_capture_rank = rank(-prop_animal_protein_marine)), 
         by = "iso3c")

# Create plot
(aquatic_reliance_rank_change <- aquatic_reliance_ranks %>%
  filter(total_rank <= 25 | marine_capture_rank <= 25) %>%
  mutate(country_name = countrycode(iso3c, origin = "iso3c", destination = "country.name"),
         country_name = fct_reorder(country_name, -total_rank), 
         ) %>%
  ggplot() +
  geom_vline(xintercept = 25, linetype = "dashed") +
  geom_segment(aes(x = total_rank, xend = marine_capture_rank, y = country_name, yend = country_name)) +
  geom_point(aes(x = total_rank, y = country_name), color = "forestgreen", size = 1.5) +
  geom_point(aes(x = marine_capture_rank, y = country_name), color = "darkblue", size = 1.5) +
  labs(x = "Rank (lower = more reliant)", y = "") +
  theme_minimal()) 

# Save plot
ggsave("../images/aquatic_reliance_rank_change.jpg", plot = aquatic_reliance_rank_change, device = "jpeg", units = "in", width = 5, height = 4)
```
