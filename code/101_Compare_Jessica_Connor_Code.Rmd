---
title: "Compare Jessica's and Connor's Code"
author: "Connor Quiroz"
date: "2025-06-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data analysis}
# Run both Jessica's and Connor's code top to bottom to get needed objects

# Compare aquatic animal amounts between new and old datasets first element in setdiff is Connor's code, second element is Jessica's.

# AQUATIC PROTEINS
setdiff({historical_fao_props %>% 
  filter(Element == "Protein supply quantity (g/capita/day)")}$aquatic_animal_amount,{fao_old_aquatic %>% 
  filter(Element == "Protein supply quantity (g/capita/day)")}$value)

setdiff({fao_prop_imports %>% 
  filter(Element == "Protein supply quantity (g/capita/day)")}$aquatic_animal_amount,{fao_new_aquatic %>% 
  filter(Element == "Protein supply quantity (g/capita/day)")}$value)

anti_join((
  historical_fao_props %>%
    filter(Element == "Protein supply quantity (g/capita/day)")
),

(
  fao_old_aquatic %>%
    filter(Element == "Protein supply quantity (g/capita/day)")
)
,
by = c("iso3c", "year")
)

## TOTAL ANIMAL PROTEIN
setdiff({historical_fao_props %>% 
  filter(Element == "Protein supply quantity (g/capita/day)")}$total_animal_amount,{fao_old_raw %>%
  # Filter to the total animal product protein supply
  filter(Item == "Animal Products", 
         Element == "Protein supply quantity (g/capita/day)") %>%
  select("year", "iso3c", "data_source", "total_animal_protein" = "value")}$total_animal_protein)

# Check for duplicate values within each dataset
historical_fao_props %>% 
  filter(Element == "Protein supply quantity (g/capita/day)") %>%
  ungroup() %>%
  count(total_animal_amount, sort = TRUE)

fao_old_raw %>%
  filter(Item == "Animal Products", 
         Element == "Protein supply quantity (g/capita/day)") %>%
  count(value, sort = TRUE)

# Check the actual row-level differences
anti_join_result <- anti_join(
  historical_fao_props %>% filter(Element == "Protein supply quantity (g/capita/day)"),
  fao_old_raw %>% filter(Item == "Animal Products", Element == "Protein supply quantity (g/capita/day)") %>%
    select("year", "iso3c", "data_source", "total_animal_protein" = "value"), 
  by = c("iso3c", "year")
)

# Look at the values that anti_join found but setdiff didn't
unique(anti_join_result$total_animal_amount)

# Compare the datasets directly on matching rows
historical_fao_props %>% 
  filter(Element == "Protein supply quantity (g/capita/day)") %>%
  select(iso3c, year, total_animal_amount) %>%
  inner_join(
    fao_old_raw %>%
      filter(Item == "Animal Products", 
             Element == "Protein supply quantity (g/capita/day)") %>%
      select(iso3c, year, total_animal_protein = value),
    by = c("iso3c", "year")
  ) %>%
  filter(total_animal_amount != total_animal_protein)

# I'm pretty certain how we're calculating the total animal protein and aquatic animal protein is the same, the only difference is how China is processed. Down in the below graphics I find differences in our values. I suspect this is due to the different preprocessing techniques that we use for ARTIS.
```


```{r data viz}
fao_aquatic_source %>%
  filter(Element == "Protein supply quantity (g/capita/day)") %>%
  group_by(year, habitat, method, consumption_source) %>%
  summarize(mean_prop_consumption = mean(aquatic_source_prop), .groups = "drop") %>%
  filter(habitat != "unknown",
         method != "unknown") %>%
  mutate(mean_prop_consumption = 100 * mean_prop_consumption) %>%
  ggplot(aes(x = year, y = mean_prop_consumption, color = consumption_source)) +
  geom_line(size = 1.3) +
  facet_grid(habitat ~ method, scales = "free_x", space = "free_x") +
  theme_cowplot(10) +
  labs(x = "", y = "", color = "Consumption source")
  theme(legend.position = "bottom", legend.justification = "center")

supply_importance_long %>%
  filter(element == "Protein supply quantity (g/capita/day)") %>%
  group_by(year, habitat, method, consumption_source) %>%
  summarize(mean_prop_consumption = mean(aa_reliance_pct), .groups = "drop") %>%
  filter(habitat != "unknown",
         method != "unknown") %>%
  mutate(mean_prop_consumption = 100 * mean_prop_consumption) %>%
  ggplot(aes(x = year, y = mean_prop_consumption, color = consumption_source)) +
  geom_line(size = 1.3) +
  facet_grid(habitat ~ method, scales = "free_x", space = "free_x") +
  theme_cowplot(10) +
  theme(legend.position = "bottom", legend.justification = "center") +
  labs(x = "", y = "", color = "Consumption source") +
  scale_x_continuous(breaks = seq(1995, 2020, by = 10)) +
                       scale_color_manual(values = artis_palette(3))  

anti_join({fao_aquatic_source %>% filter(Element == "Protein supply quantity (g/capita/day)")},
{supply_importance_long %>% filter(element == "Protein supply quantity (g/capita/day)")}, by = c("iso3c" = "consumer_iso3c", "year", "habitat", "method", "consumption_source"))

supply_importance_long %>% filter(consumer_iso3c == "BOL")


hist({fao_aquatic_source %>% filter(Element == "Protein supply quantity (g/capita/day)")}$aquatic_source_prop)
hist({supply_importance_long %>% filter(element == "Protein supply quantity (g/capita/day)")}$aa_reliance_pct)
```

```{r comparing ARTIS consumption preprocessing}
# Connor's preprocessed consumption data:
habitat_method_props

# Jessica's preprocessed consumption data
consumption_props

# A LOT of differences between our calculated proportions
setdiff(habitat_method_props$prop_consumption, consumption_props$aquatic_source_prop)

setdiff({fao_aquatic_source %>%
  filter(Element == "Protein supply quantity (g/capita/day)")}$aquatic_source_prop,
  {supply_importance_long %>%
  filter(element == "Protein supply quantity (g/capita/day)")}$aa_reliance_pct)
```

```{r trying stuff}
{fao_prop_imports %>% filter(Element == "Protein supply quantity (g/capita/day)")}$total_animal_amount,
{fao_new_raw %>%
  # Filter to the total animal product protein supply
  filter(Item == "Animal Products", 
         Element == "Protein supply quantity (g/capita/day)") %>%
  select("year", "iso3c", "data_source", "total_animal_protein" = "value") %>%
  arrange(iso3c)}$total_animal_protein %>%
  filter()
```

